<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>AM Lernkarten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f766e">

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      background: #0b1120;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .app {
      width: 100%;
      max-width: 960px;
      padding: 1rem;
    }
    h1, h2, h3 { margin: .5rem 0; }
    .card {
      background: #020617;
      border-radius: .75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #1f2937;
    }
    button {
      border-radius: 999px;
      border: 1px solid #0d9488;
      background: #0f766e;
      color: white;
      padding: .4rem .9rem;
      font: inherit;
      cursor: pointer;
    }
    button.secondary {
      background: transparent;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    button.small { padding: .3rem .6rem; font-size: .8rem; }
    input[type="text"], input[type="date"], textarea {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      border-radius: .5rem;
      padding: .5rem;
      font: inherit;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }
    .row { display: flex; gap: .5rem; flex-wrap: wrap; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .badge {
      background: #111827;
      padding: .2rem .6rem;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: .75rem;
    }
    .deck-item {
      display: flex;
      justify-content: space-between;
      padding: .4rem 0;
      border-bottom: 1px solid #111827;
      align-items: center;
    }
    .deck-main { cursor: pointer; flex: 1; }
    .fc-card {
      min-height: 150px;
      border: 1px dashed #4b5563;
      border-radius: .75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      cursor: pointer;
      user-select: none;
    }
    .fc-label { font-size: .75rem; color: #9ca3af; text-transform: uppercase; }
    .fc-text { font-size: 1.2rem; white-space: pre-wrap; }
    .muted { color: #9ca3af; font-size: .85rem; }
  </style>
</head>

<body>
<div class="app">

  <h1>AM Lernkarten</h1>
  <p class="muted">Lerne deine Karteikarten für Additive Fertigung. Jetzt auch mit TSV-Import.</p>

  <!-- =========================
       VIEW: DECK LIST
  =============================-->
  <div id="view-deck-list" class="card">
    <div class="flex-between">
      <h2>Stapel</h2>
      <button id="btn-export" class="secondary small">Backup exportieren</button>
    </div>

    <!-- Neues Deck -->
    <div class="row mt-sm">
      <input id="new-deck-name" type="text" placeholder="Neuer Stapelname" style="flex:1" />
      <button id="btn-add-deck">Anlegen</button>
    </div>

    <!-- TSV Import -->
    <div class="row mt-sm">
      <input id="file-import" type="file" accept=".tsv,.txt" />
      <button id="btn-import" class="secondary small">TSV-Deck importieren</button>
    </div>

    <div id="deck-list" class="mt-sm"></div>
  </div>

  <!-- =========================
       VIEW: DECK DETAIL
  =============================-->
  <div id="view-deck-detail" class="card" style="display:none;">
    <button id="btn-back" class="secondary small">⬅ Zurück</button>

    <h2>Stapel bearbeiten</h2>
    <input id="deck-name-edit" type="text" class="mt-sm" />

    <div class="row mt-sm">
      <label>Klausurdatum:</label>
      <input id="deck-exam-date" type="date" />
    </div>

    <div class="card mt" style="background:#0f172a;">
      <h3>Lernplan</h3>
      <div id="plan-info" class="muted"></div>
    </div>

    <h3 class="mt">Karten <span id="card-count-badge" class="badge"></span></h3>
    <div id="card-list"></div>

    <details class="mt">
      <summary>Karte hinzufügen</summary>
      <textarea id="new-card-front" placeholder="Vorderseite"></textarea>
      <textarea id="new-card-back" placeholder="Rückseite"></textarea>
      <button id="btn-add-card" class="mt-sm">Speichern</button>
    </details>

    <div class="row mt">
      <button id="btn-start-study">Lernen</button>
      <button id="btn-delete-deck" class="secondary small">Stapel löschen</button>
    </div>
  </div>

  <!-- =========================
       VIEW: STUDY MODE
  =============================-->
  <div id="view-study" class="card" style="display:none;">
    <button id="btn-exit-study" class="secondary small">⬅ Beenden</button>

    <div id="study-progress" class="muted"></div>

    <div id="study-card" class="fc-card mt">
      <div>
        <div id="study-face-label" class="fc-label">Frage</div>
        <div id="study-text" class="fc-text"></div>
      </div>
    </div>

    <div class="row mt">
      <button id="btn-toggle-face">Antwort anzeigen</button>
      <button id="btn-next" class="secondary">Nächste</button>
    </div>
  </div>

</div>

<!-- ============================================================
     JAVASCRIPT LOGIK
===============================================================-->
<script>
  /* === Globale Variablen === */
  const STORAGE_KEY = "am_flashcards_v1";
  let state = loadState();
  let currentDeckId = null;

  let study = {
    deckId: null,
    index: 0,
    showBack: false,
    order: []
  };

  /* === Hilfsfunktionen === */
  function uuid() {
    return crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2);
  }

  function loadState() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { decks: [] };
    } catch {
      return { decks: [] };
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    render();
  }

  function getDeck() {
    return state.decks.find(d => d.id === currentDeckId);
  }

  function computePlan(deck) {
    if (!deck.examDate || deck.cards.length === 0) return null;
    const today = new Date();
    const exam = new Date(deck.examDate);
    const diff = Math.ceil((exam - today) / (1000 * 60 * 60 * 24));
    if (diff <= 0) return { daysLeft: diff };
    return {
      daysLeft: diff,
      cardsPerDay: Math.ceil(deck.cards.length / diff)
    };
  }

  /* ================================
     TSV-Import
  =================================*/
  function importTSV(text, filename) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (lines.length === 0) return alert("Die Datei ist leer.");

    let start = 0;
    const header = lines[0].split("\t");
    if (/front/i.test(header[0]) && /back|r.ckseite/i.test(header[1])) start = 1;

    const cards = [];
    for (let i = start; i < lines.length; i++) {
      const [front, back] = lines[i].split("\t");
      if (!front || !back) continue;
      cards.push({
        id: uuid(),
        front: front.trim(),
        back: back.trim(),
        lastReviewed: null,
        timesSeen: 0
      });
    }

    if (!cards.length) return alert("Keine gültigen Karten gefunden.");

    const deckName = filename.replace(/\.[^.]+$/, "");
    state.decks.push({
      id: uuid(),
      name: deckName,
      examDate: "",
      cards
    });

    saveState();
    alert(`Deck "${deckName}" importiert (${cards.length} Karten).`);
  }

  /* ================================
     Rendering
  =================================*/
  function render() {
    const vList = document.getElementById("view-deck-list");
    const vDetail = document.getElementById("view-deck-detail");
    const vStudy = document.getElementById("view-study");

    if (study.deckId) {
      vList.style.display = "none";
      vDetail.style.display = "none";
      vStudy.style.display = "block";
      renderStudyView();
      return;
    }

    if (currentDeckId) {
      vList.style.display = "none";
      vDetail.style.display = "block";
      vStudy.style.display = "none";
      renderDeckDetail();
      return;
    }

    vList.style.display = "block";
    vDetail.style.display = "none";
    vStudy.style.display = "none";
    renderDeckList();
  }

  function renderDeckList() {
    const el = document.getElementById("deck-list");
    el.innerHTML = "";

    state.decks.forEach(deck => {
      const div = document.createElement("div");
      div.className = "deck-item";

      const main = document.createElement("div");
      main.className = "deck-main";
      main.onclick = () => { currentDeckId = deck.id; render(); };

      const name = document.createElement("div");
      name.textContent = deck.name;
      const meta = document.createElement("div");
      meta.className = "muted";
      meta.textContent = `${deck.cards.length} Karten`;

      main.appendChild(name);
      main.appendChild(meta);

      const learn = document.createElement("button");
      learn.textContent = "Lernen";
      learn.className = "small";
      learn.onclick = e => { e.stopPropagation(); startStudy(deck.id); };

      div.appendChild(main);
      div.appendChild(learn);
      el.appendChild(div);
    });
  }

  function renderDeckDetail() {
    const deck = getDeck();
    if (!deck) return;

    document.getElementById("deck-name-edit").value = deck.name;
    document.getElementById("deck-exam-date").value = deck.examDate;

    const plan = computePlan(deck);
    const planDiv = document.getElementById("plan-info");
    planDiv.innerHTML = plan
      ? `Tage bis Klausur: ${plan.daysLeft}<br>Karten/Tag: ${plan.cardsPerDay}`
      : "Kein Klausurdatum gesetzt.";

    const badge = document.getElementById("card-count-badge");
    badge.textContent = deck.cards.length;

    const list = document.getElementById("card-list");
    list.innerHTML = "";

    deck.cards.forEach((c, idx) => {
      const div = document.createElement("div");
      div.innerHTML = `<strong>${idx + 1}.</strong> ${c.front}`;
      list.appendChild(div);
    });
  }

  function renderStudyView() {
    const deck = state.decks.find(d => d.id === study.deckId);
    const cardIndex = study.order[study.index];
    const card = deck.cards[cardIndex];

    document.getElementById("study-progress").textContent =
      `Karte ${study.index + 1} von ${deck.cards.length}`;

    document.getElementById("study-face-label").textContent =
      study.showBack ? "Antwort" : "Frage";

    document.getElementById("study-text").textContent =
      study.showBack ? card.back : card.front;
  }

  /* ================================
     Aktionen
  =================================*/
  document.getElementById("btn-add-deck").onclick = () => {
    const name = document.getElementById("new-deck-name").value.trim();
    if (!name) return;
    state.decks.push({
      id: uuid(),
      name,
      examDate: "",
      cards: []
    });
    saveState();
  };

  document.getElementById("btn-import").onclick = () => {
    const file = document.getElementById("file-import").files[0];
    if (!file) return alert("Bitte eine TSV-Datei auswählen.");
    const reader = new FileReader();
    reader.onload = e => importTSV(e.target.result, file.name);
    reader.readAsText(file, "utf-8");
  };

  document.getElementById("deck-name-edit").oninput = e => {
    const deck = getDeck();
    deck.name = e.target.value;
    saveState();
  };

  document.getElementById("deck-exam-date").onchange = e => {
    const deck = getDeck();
    deck.examDate = e.target.value;
    saveState();
  };

  document.getElementById("btn-add-card").onclick = () => {
    const deck = getDeck();
    const front = document.getElementById("new-card-front").value.trim();
    const back = document.getElementById("new-card-back").value.trim();
    if (!front || !back) return;

    deck.cards.push({ id: uuid(), front, back, timesSeen: 0 });
    saveState();
  };

  document.getElementById("btn-start-study").onclick = () => {
    startStudy(currentDeckId);
  };

  function startStudy(deckId) {
    const deck = state.decks.find(d => d.id === deckId);
    if (!deck || deck.cards.length === 0) return;

    study.deckId = deckId;
    study.showBack = false;
    study.index = 0;
    study.order = deck.cards.map((_, i) => i).sort(() => Math.random() - 0.5);

    render();
  }

  document.getElementById("btn-toggle-face").onclick = () => {
    study.showBack = !study.showBack;
    renderStudyView();
  };

  document.getElementById("btn-next").onclick = () => {
    const deck = state.decks.find(d => d.id === study.deckId);
    study.index = (study.index + 1) % deck.cards.length;
    study.showBack = false;
    renderStudyView();
  };

  document.getElementById("btn-exit-study").onclick = () => {
    study.deckId = null;
    render();
  };

  document.getElementById("btn-back").onclick = () => {
    currentDeckId = null;
    render();
  };

  document.getElementById("btn-delete-deck").onclick = () => {
    if (!confirm("Diesen Stapel löschen?")) return;
    state.decks = state.decks.filter(d => d.id !== currentDeckId);
    currentDeckId = null;
    saveState();
  };

  document.getElementById("btn-export").onclick = () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "backup.json";
    a.click();
  };

  /* ================================
     Service Worker
  =================================*/
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }

  render();
</script>

</body>
</html>


