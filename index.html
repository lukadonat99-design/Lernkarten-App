<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>AM Lernkarten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f766e">

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      background: #0b1120;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .app {
      width: 100%;
      max-width: 960px;
      padding: 1rem;
    }
    h1, h2, h3 { margin: .5rem 0; }
    .card {
      background: #020617;
      border-radius: .75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #1f2937;
    }
    button {
      border-radius: 999px;
      border: 1px solid #0d9488;
      background: #0f766e;
      color: white;
      padding: .4rem .9rem;
      font: inherit;
      cursor: pointer;
    }
    button.secondary {
      background: transparent;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    button.small { padding: .3rem .6rem; font-size: .8rem; }
    input[type="text"], input[type="date"], textarea, input[type="file"] {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      border-radius: .5rem;
      padding: .5rem;
      font: inherit;
    }
    input[type="file"] {
      padding: .3rem;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }
    .row { display: flex; gap: .5rem; flex-wrap: wrap; }
    .mt-sm { margin-top: .5rem; }
    .mt    { margin-top: 1rem; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .badge {
      background: #111827;
      padding: .2rem .6rem;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: .75rem;
    }
    .deck-item {
      display: flex;
      justify-content: space-between;
      padding: .4rem 0;
      border-bottom: 1px solid #111827;
      align-items: center;
    }
    .deck-main { cursor: pointer; flex: 1; }
    .fc-card {
      min-height: 150px;
      border: 1px dashed #4b5563;
      border-radius: .75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      cursor: pointer;
      user-select: none;
    }
    .fc-label { font-size: .75rem; color: #9ca3af; text-transform: uppercase; }
    .fc-text { font-size: 1.2rem; white-space: pre-wrap; }
    .muted { color: #9ca3af; font-size: .85rem; }
  </style>
</head>

<body>
<div class="app">

  <h1>AM Lernkarten</h1>
  <p class="muted">
    Lerne deine Karteikarten für Additive Fertigung – mit Lernstufen, Klausur-Lernziel, 5-Minuten-Wiederholung bei Fehlern und TSV-Import.
  </p>

  <!-- =========================
       VIEW: DECK LIST
  =============================-->
  <div id="view-deck-list" class="card">
    <div class="flex-between">
      <h2>Stapel</h2>
      <button id="btn-export" class="secondary small">Backup exportieren</button>
    </div>

    <!-- Neues Deck -->
    <div class="row mt-sm">
      <input id="new-deck-name" type="text" placeholder="Neuer Stapelname" style="flex:1" />
      <button id="btn-add-deck">Anlegen</button>
    </div>

    <!-- TSV Import (neues Deck) -->
    <div class="row mt-sm">
      <input id="file-import" type="file" accept=".tsv,.txt" />
      <button id="btn-import" class="secondary small">TSV-Deck importieren (neuer Stapel)</button>
    </div>

    <div id="deck-list" class="mt-sm"></div>
  </div>

  <!-- =========================
       VIEW: DECK DETAIL
  =============================-->
  <div id="view-deck-detail" class="card" style="display:none;">
    <button id="btn-back" class="secondary small">⬅ Zurück</button>

    <h2>Stapel bearbeiten</h2>
    <input id="deck-name-edit" type="text" class="mt-sm" />

    <div class="row mt-sm">
      <label>Klausurdatum:</label>
      <input id="deck-exam-date" type="date" />
    </div>

    <div class="card mt" style="background:#0f172a;">
      <h3>Lernplan</h3>
      <div id="plan-info" class="muted"></div>
    </div>

    <h3 class="mt">
      Karten <span id="card-count-badge" class="badge"></span>
    </h3>

    <!-- TSV Import in bestehenden Stapel -->
    <div class="row mt-sm">
      <input id="file-import-deck" type="file" accept=".tsv,.txt" />
      <button id="btn-import-deck" class="secondary small">TSV in diesen Stapel importieren</button>
    </div>

    <div id="card-list" class="mt-sm"></div>

    <details class="mt">
      <summary>Karte hinzufügen</summary>
      <textarea id="new-card-front" placeholder="Vorderseite"></textarea>
      <textarea id="new-card-back" placeholder="Rückseite"></textarea>
      <button id="btn-add-card" class="mt-sm">Speichern</button>
    </details>

    <div class="row mt">
      <button id="btn-start-study-plan">Nach Lernplan lernen</button>
      <button id="btn-start-study-all" class="secondary">Alle Karten lernen</button>
      <button id="btn-delete-deck" class="secondary small">Stapel löschen</button>
    </div>
  </div>

  <!-- =========================
       VIEW: STUDY MODE
  =============================-->
  <div id="view-study" class="card" style="display:none;">
    <button id="btn-exit-study" class="secondary small">⬅ Beenden</button>

    <div id="study-progress" class="muted mt-sm"></div>

    <div id="study-card" class="fc-card mt">
      <div>
        <div id="study-face-label" class="fc-label">Frage</div>
        <div id="study-text" class="fc-text"></div>
      </div>
    </div>

    <div class="row mt">
      <button id="btn-toggle-face">Antwort anzeigen</button>
      <button id="btn-mark-correct" class="small">Richtig</button>
      <button id="btn-mark-wrong" class="secondary small">Falsch</button>
      <button id="btn-next" class="secondary small">Überspringen</button>
    </div>
  </div>

</div>

<!-- ============================================================
     JAVASCRIPT LOGIK
===============================================================-->
<script>
  const STORAGE_KEY = "am_flashcards_v3";

  let state = loadState();
  let currentDeckId = null;

  // Lernmodus: 'plan' (fällige Karten) oder 'all' (alle Karten)
  let study = {
    deckId: null,
    mode: "plan",
    index: 0,
    showBack: false,
    order: []
  };

  /* === Hilfsfunktionen === */
  function uuid() {
    return crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2);
  }

  function todayDateOnly() {
    const d = new Date();
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { decks: [] };
      const s = JSON.parse(raw);

      s.decks.forEach(deck => {
        deck.cards.forEach(c => {
          if (typeof c.stage === "undefined") c.stage = 0;
          if (!c.nextReviewAt) c.nextReviewAt = new Date().toISOString();
        });
      });

      return s;
    } catch {
      return { decks: [] };
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    render();
  }

  function getDeck() {
    return state.decks.find(d => d.id === currentDeckId);
  }

  // Lernziel: alle Karten bis Stufe 5 -> fehlende Wiederholungen zählen
  function computePlan(deck) {
    if (!deck.examDate || deck.cards.length === 0) return null;

    const today = todayDateOnly();
    const exam = new Date(deck.examDate + "T00:00:00");
    if (Number.isNaN(exam.getTime())) return null;

    const diffMs = exam - today;
    const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

    let remainingReviews = 0;
    deck.cards.forEach(c => {
      const stage = c.stage || 0;
      const missing = Math.max(0, 5 - stage);
      remainingReviews += missing;
    });

    if (daysLeft <= 0) {
      return { daysLeft, remainingReviews, reviewsPerDay: null };
    }

    const reviewsPerDay = Math.ceil(remainingReviews / daysLeft);
    return { daysLeft, remainingReviews, reviewsPerDay };
  }

  /* ================================
     TSV-Parsing (wiederverwendbar)
  =================================*/
  function parseTSVToCards(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
    if (!lines.length) return [];

    let start = 0;
    const header = lines[0].split("\t");
    if (/front|vorder/i.test(header[0]) && /back|r.ckseite/i.test(header[1])) {
      start = 1; // Header überspringen
    }

    const cards = [];
    const nowIso = new Date().toISOString();

    for (let i = start; i < lines.length; i++) {
      const parts = lines[i].split("\t");
      if (parts.length < 2) continue;
      const front = parts[0].trim();
      const back = parts[1].trim();
      if (!front || !back) continue;
      cards.push({
        id: uuid(),
        front,
        back,
        lastReviewed: null,
        timesSeen: 0,
        stage: 0,
        nextReviewAt: nowIso
      });
    }

    return cards;
  }

  function importTSV_asNewDeck(text, filename) {
    const cards = parseTSVToCards(text);
    if (!cards.length) {
      alert("Keine gültigen Karten in der TSV-Datei gefunden.");
      return;
    }

    const deckName = filename.replace(/\.[^.]+$/, "") || "Importiertes Deck";
    state.decks.push({
      id: uuid(),
      name: deckName,
      examDate: "",
      cards
    });

    saveState();
    alert(`Deck "${deckName}" importiert (${cards.length} Karten).`);
  }

  function importTSV_intoExistingDeck(text, deck) {
    const cards = parseTSVToCards(text);
    if (!cards.length) {
      alert("Keine gültigen Karten in der TSV-Datei gefunden.");
      return;
    }

    deck.cards.push(...cards);
    saveState();
    alert(`${cards.length} Karten wurden zu "${deck.name}" hinzugefügt.`);
  }

  /* ================================
     Render-Logik
  =================================*/
  function render() {
    const vList = document.getElementById("view-deck-list");
    const vDetail = document.getElementById("view-deck-detail");
    const vStudy = document.getElementById("view-study");

    if (study.deckId) {
      vList.style.display = "none";
      vDetail.style.display = "none";
      vStudy.style.display = "block";
      renderStudyView();
      return;
    }

    if (currentDeckId) {
      vList.style.display = "none";
      vDetail.style.display = "block";
      vStudy.style.display = "none";
      renderDeckDetail();
      return;
    }

    vList.style.display = "block";
    vDetail.style.display = "none";
    vStudy.style.display = "none";
    renderDeckList();
  }

  function renderDeckList() {
    const el = document.getElementById("deck-list");
    el.innerHTML = "";

    if (!state.decks.length) {
      el.innerHTML = '<p class="muted">Noch keine Stapel angelegt.</p>';
      return;
    }

    state.decks.forEach(deck => {
      const div = document.createElement("div");
      div.className = "deck-item";

      const main = document.createElement("div");
      main.className = "deck-main";
      main.onclick = () => { currentDeckId = deck.id; render(); };

      const name = document.createElement("div");
      name.textContent = deck.name || "Unbenannter Stapel";

      const meta = document.createElement("div");
      meta.className = "muted";

      let metaStr = `${deck.cards.length} Karten`;
      if (deck.examDate) {
        const plan = computePlan(deck);
        if (plan) {
          if (plan.daysLeft > 0 && plan.reviewsPerDay !== null) {
            metaStr += ` • ${plan.daysLeft} Tage • ca. ${plan.reviewsPerDay} Wiederh./Tag`;
          } else if (plan.daysLeft <= 0) {
            metaStr += " • Klausurdatum erreicht/überschritten";
          }
        }
      }
      meta.textContent = metaStr;

      main.appendChild(name);
      main.appendChild(meta);

      const learnBtn = document.createElement("button");
      learnBtn.textContent = "Plan";
      learnBtn.className = "small";
      learnBtn.onclick = e => {
        e.stopPropagation();
        startStudy(deck.id, "plan");
      };

      const allBtn = document.createElement("button");
      allBtn.textContent = "Alle";
      allBtn.className = "secondary small";
      allBtn.style.marginLeft = ".25rem";
      allBtn.onclick = e => {
        e.stopPropagation();
        startStudy(deck.id, "all");
      };

      const right = document.createElement("div");
      right.appendChild(learnBtn);
      right.appendChild(allBtn);

      div.appendChild(main);
      div.appendChild(right);
      el.appendChild(div);
    });
  }

  function renderDeckDetail() {
    const deck = getDeck();
    if (!deck) return;

    document.getElementById("deck-name-edit").value = deck.name || "";
    document.getElementById("deck-exam-date").value = deck.examDate || "";

    const plan = computePlan(deck);
    const planDiv = document.getElementById("plan-info");

    if (!deck.examDate) {
      planDiv.innerHTML = "Setze ein Klausurdatum, um einen Lernplan zu erzeugen.";
    } else if (!plan) {
      planDiv.innerHTML = "Keine Plan-Daten verfügbar.";
    } else if (plan.daysLeft <= 0) {
      planDiv.innerHTML =
        `Klausurdatum erreicht oder überschritten.<br>` +
        `Fehlende Wiederholungen bis Stufe 5: <strong>${plan.remainingReviews}</strong>.`;
    } else {
      planDiv.innerHTML =
        `Tage bis Klausur: <strong>${plan.daysLeft}</strong><br>` +
        `Fehlende Wiederholungen bis Stufe 5: <strong>${plan.remainingReviews}</strong><br>` +
        `Empfohlen: ca. <strong>${plan.reviewsPerDay}</strong> Wiederholungen/Tag.`;
    }

    const badge = document.getElementById("card-count-badge");
    badge.textContent = deck.cards.length;

    const list = document.getElementById("card-list");
    list.innerHTML = "";

    deck.cards.forEach((c, idx) => {
      const div = document.createElement("div");
      div.className = "mt-sm";
      const stage = c.stage || 0;
      let nextStr = "-";
      if (c.nextReviewAt) {
        const d = new Date(c.nextReviewAt);
        if (!Number.isNaN(d.getTime())) {
          nextStr = d.toLocaleString("de-DE");
        }
      }
      div.innerHTML =
        `<div><strong>${idx + 1}.</strong> ${c.front}</div>` +
        `<div class="muted">Stufe: ${stage}/5 • Nächste Wiederholung: ${nextStr}</div>`;
      list.appendChild(div);
    });
  }

  function renderStudyView() {
    const deck = state.decks.find(d => d.id === study.deckId);
    if (!deck) return;

    if (!study.order.length) {
      document.getElementById("study-progress").textContent =
        study.mode === "plan"
          ? "Aktuell sind keine Karten laut Lernplan fällig."
          : "Keine Karten im Stapel.";
      document.getElementById("study-text").textContent = "";
      return;
    }

    const idx = study.order[study.index];
    const card = deck.cards[idx];

    document.getElementById("study-progress").textContent =
      `Modus: ${study.mode === "plan" ? "Lernplan" : "Alle Karten"} • ` +
      `Karte ${study.index + 1} von ${study.order.length} • Stufe ${card.stage || 0}/5`;

    document.getElementById("study-face-label").textContent =
      study.showBack ? "Antwort" : "Frage";

    document.getElementById("study-text").textContent =
      study.showBack ? card.back : card.front;
  }

  /* ================================
     Lern-Logik (Stufen + Zeit)
  =================================*/
  function scheduleCorrect(card, examDateStr) {
    let stage = card.stage || 0;
    if (stage < 5) stage += 1;
    card.stage = stage;

    let intervalDays;
    switch (stage) {
      case 1: intervalDays = 1; break;
      case 2: intervalDays = 2; break;
      case 3: intervalDays = 3; break;
      case 4: intervalDays = 7; break;
      default: intervalDays = 15; break;
    }

    const now = new Date();
    let next = new Date(now.getTime() + intervalDays * 24 * 60 * 60 * 1000);

    if (examDateStr) {
      const exam = new Date(examDateStr + "T23:59:59");
      if (!Number.isNaN(exam.getTime()) && next > exam) {
        next = exam;
      }
    }

    card.nextReviewAt = next.toISOString();
    card.lastReviewed = now.toISOString();
    card.timesSeen = (card.timesSeen || 0) + 1;
  }

  function scheduleWrong(card, examDateStr) {
    // Zurück auf Stufe 0, Wiederholung nach 5 Minuten
    card.stage = 0;

    const now = new Date();
    let next = new Date(now.getTime() + 5 * 60 * 1000); // +5 Minuten

    if (examDateStr) {
      const exam = new Date(examDateStr + "T23:59:59");
      if (!Number.isNaN(exam.getTime()) && next > exam) {
        next = exam;
      }
    }

    card.nextReviewAt = next.toISOString();
    card.lastReviewed = now.toISOString();
    card.timesSeen = (card.timesSeen || 0) + 1;
  }

  function startStudy(deckId, mode) {
    const deck = state.decks.find(d => d.id === deckId);
    if (!deck || !deck.cards.length) {
      alert("In diesem Stapel sind noch keine Karten.");
      return;
    }

    study.mode = mode || "plan";
    study.deckId = deckId;
    study.showBack = false;

    const now = new Date();
    let indices;

    if (study.mode === "plan") {
      indices = deck.cards
        .map((c, i) => ({ c, i }))
        .filter(obj => {
          if (!obj.c.nextReviewAt) return true;
          const d = new Date(obj.c.nextReviewAt);
          if (Number.isNaN(d.getTime())) return true;
          return d <= now;
        })
        .map(obj => obj.i);

      if (!indices.length) {
        alert("Aktuell sind keine Karten laut Lernplan fällig. Du kannst 'Alle Karten lernen' wählen.");
        study.deckId = null;
        render();
        return;
      }
    } else {
      indices = deck.cards.map((_, i) => i);
    }

    for (let i = indices.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }

    study.order = indices;
    study.index = 0;
    renderStudyView();
  }

  function gotoNextCard() {
    const deck = state.decks.find(d => d.id === study.deckId);
    if (!deck) return;

    if (!study.order.length) {
      study.deckId = null;
      render();
      return;
    }

    study.index++;
    if (study.index >= study.order.length) {
      alert("Lerndurchgang abgeschlossen.");
      study.deckId = null;
      render();
    } else {
      study.showBack = false;
      renderStudyView();
    }
  }

  /* ================================
     Event-Handler
  =================================*/
  document.getElementById("btn-add-deck").onclick = () => {
    const name = document.getElementById("new-deck-name").value.trim();
    if (!name) return;
    state.decks.push({
      id: uuid(),
      name,
      examDate: "",
      cards: []
    });
    document.getElementById("new-deck-name").value = "";
    saveState();
  };

  document.getElementById("btn-import").onclick = () => {
    const file = document.getElementById("file-import").files[0];
    if (!file) {
      alert("Bitte eine TSV-Datei auswählen.");
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      importTSV_asNewDeck(e.target.result, file.name);
      document.getElementById("file-import").value = "";
    };
    reader.readAsText(file, "utf-8");
  };

  document.getElementById("btn-import-deck").onclick = () => {
    const deck = getDeck();
    if (!deck) {
      alert("Kein Stapel ausgewählt.");
      return;
    }
    const file = document.getElementById("file-import-deck").files[0];
    if (!file) {
      alert("Bitte eine TSV-Datei auswählen.");
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      importTSV_intoExistingDeck(e.target.result, deck);
      document.getElementById("file-import-deck").value = "";
    };
    reader.readAsText(file, "utf-8");
  };

  document.getElementById("deck-name-edit").oninput = e => {
    const deck = getDeck();
    if (!deck) return;
    deck.name = e.target.value;
    saveState();
  };

  document.getElementById("deck-exam-date").onchange = e => {
    const deck = getDeck();
    if (!deck) return;
    deck.examDate = e.target.value || "";
    saveState();
  };

  document.getElementById("btn-add-card").onclick = () => {
    const deck = getDeck();
    if (!deck) return;
    const front = document.getElementById("new-card-front").value.trim();
    const back = document.getElementById("new-card-back").value.trim();
    if (!front || !back) return;
    const nowIso = new Date().toISOString();
    deck.cards.push({
      id: uuid(),
      front,
      back,
      lastReviewed: null,
      timesSeen: 0,
      stage: 0,
      nextReviewAt: nowIso
    });
    document.getElementById("new-card-front").value = "";
    document.getElementById("new-card-back").value = "";
    saveState();
  };

  document.getElementById("btn-start-study-plan").onclick = () => {
    if (!currentDeckId) return;
    startStudy(currentDeckId, "plan");
  };

  document.getElementById("btn-start-study-all").onclick = () => {
    if (!currentDeckId) return;
    startStudy(currentDeckId, "all");
  };

  document.getElementById("btn-delete-deck").onclick = () => {
    const deck = getDeck();
    if (!deck) return;
    if (!confirm(`Stapel "${deck.name}" wirklich löschen?`)) return;
    state.decks = state.decks.filter(d => d.id !== deck.id);
    currentDeckId = null;
    saveState();
  };

  document.getElementById("btn-back").onclick = () => {
    currentDeckId = null;
    render();
  };

  document.getElementById("btn-exit-study").onclick = () => {
    study.deckId = null;
    render();
  };

  document.getElementById("btn-toggle-face").onclick = () => {
    study.showBack = !study.showBack;
    renderStudyView();
  };

  document.getElementById("btn-mark-correct").onclick = () => {
    const deck = state.decks.find(d => d.id === study.deckId);
    if (!deck || !study.order.length) return;
    const idx = study.order[study.index];
    const card = deck.cards[idx];
    scheduleCorrect(card, deck.examDate);
    saveState();
    gotoNextCard();
  };

  document.getElementById("btn-mark-wrong").onclick = () => {
    const deck = state.decks.find(d => d.id === study.deckId);
    if (!deck || !study.order.length) return;
    const idx = study.order[study.index];
    const card = deck.cards[idx];
    scheduleWrong(card, deck.examDate);
    saveState();
    gotoNextCard();
  };

  document.getElementById("btn-next").onclick = () => {
    gotoNextCard();
  };

  document.getElementById("btn-export").onclick = () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "am_flashcards_backup.json";
    a.click();
  };

  /* ================================
     Service Worker
  =================================*/
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js").catch(console.error);
  }

  render();
</script>

</body>
</html>
